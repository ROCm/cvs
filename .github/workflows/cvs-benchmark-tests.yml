name: CVS sglang Benchmark

on:
  push:
    branches:
      - users/arravikum/sglang_tests
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of Benchmark test run"
        type: string
        required: true
        default: "sglang-test"
  pull_request:
    types:
      - labeled
      - opened
      - synchronize
      

permissions:
  contents: read

jobs:
  cvs-sglang-jaxmax-benchmark:
    name: cvs sglang-jaxmax Benchmark Tests
    runs-on: linux-TW-mi355-scale-runner
    steps:

      - name: Test sglang Benchmark Tests
        shell: bash
        run: |
          source /home/arravikum@amd.com/TheRock/.venv/bin/activate
          cd /home/arravikum@amd.com/cvs_sglang_jax/cvs/cvs
          pytest -vvv \
            --log-file=./sglang.log \
            -s ./tests/inference/sglang/disagg_pd_deepseek_r1.py \
            --cluster_file ./input/cluster_file/4_nodes.json \
            --config_file ./input/config_file/inference/sglang/sglang_disagg_pd_mi35x.json \
            --html=/home/arravikum@amd.com/latest_deepseek_4p_4d.html \
            --capture=tee-sys \
            --self-contained-html

      - name: Collect HTML benchmark report
        if: always()
        shell: bash
        run: |
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp /home/arravikum@amd.com/latest_deepseek_4p_4d.html \
             $GITHUB_WORKSPACE/artifacts/latest_deepseek_4p_4d.html

      - name: Upload benchmark HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sglang-benchmark-html-report
          path: artifacts/latest_deepseek_4p_4d.html
          if-no-files-found: warn
          retention-days: 30





          